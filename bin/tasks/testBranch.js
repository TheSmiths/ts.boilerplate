module.exports = function (options) {
    var utils = require('gulp-util'),
        git = require('gulp-git'),
        exec = require('child_process').exec,
        path = require('path'),
        gitUtils = require('../utils/git-utils.js');

    return {
        /* Create a test branch */
        create: function (callback) {
            git.checkout('test', {args: '-b'}, function (err) {
                if (err) { return callback(err); }

                exec("mkdir test", function () {
                    /* Prepare a gulpfile to easily launch test */
                    utils.log("Adding taskrunner.");
                    var gulpfile =  path.join(options.root, 'component_files', options.type, 'gulpfile.js');

                    exec("npm install gulp", function (err) {
                        exec("cp " + [gulpfile, options.processRoot].join(' '), callback);
                    });
                });
            });
        },

        /* Commit everything on this test branch */
        addAndCommit: function (callback) {
            utils.log("Adding & commiting files on the test branch");

            var msg = 'Add autogenerated test env',
                files = ['./test', '*.js', './node_modules'],
                options = '--force --all';
            gitUtils.addAndCommit(files, msg, options, callback);
        }
    };
};
