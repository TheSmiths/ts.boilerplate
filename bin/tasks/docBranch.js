module.exports = function (options) {
    var utils = require('gulp-util'),
        git = require('gulp-git'),
        exec = require('child_process').exec,
        path = require('path'),
        fs = require('fs'),
        gitUtils = require('../utils/git-utils.js');

    return {
        /* Setup the documentation branch */
        create: function (callback) {
            git.checkout('doc', {args: '-b'}, function (err) {
                if (err) { return callback(err); }
                var gemfile =  path.join(options.root, 'component_files', 'doc', 'jsduck-6.1.0.beta.gem'),
                    gulpfile = path.join(options.root, 'component_files', 'doc', 'gulpfile.js'),
                    jsduckSrc = path.join(options.root, 'component_files', 'doc', 'jsduck.json'),
                    jsduckTo = path.join(options.processRoot, 'jsduck.json');

                utils.log("Installing gem jsduck. Be sure you own the access to system files.");
                exec('gem install ' + gemfile, function (err) {
                    if (err) { return callback(err); }
                    utils.log("Copying gulpfile and jsduck config file");
                    exec('cp ' + gulpfile + ' ' + options.processRoot, function (err) {
                        /* Update the .json file to add the name of the component as a title  */
                        var content = JSON.parse(fs.readFileSync(jsduckSrc));
                        content['--title'] = options.name + " 0.1";
                        fs.writeFile(jsduckTo, JSON.stringify(content, null, "    "), function (err) {
                            if (err) { return callback(err); }
                            exec("npm install gulp", callback);
                        }); 
                    });
                });
            });
        },

        /* Commit everything on this doc branch */
        addAndCommit: function (callback) {
            utils.log("Adding & commiting files on the doc branch");
            var msg = 'Add autogenerated doc env',
                files = ['jsduck.json', './node_modules', 'gulpfile.js'],
                options = '--force --all';
            gitUtils.addAndCommit(files, msg, options, callback);
        }
    };
};
